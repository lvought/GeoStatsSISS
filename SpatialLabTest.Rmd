---
title: "SpatialEconLab"
author: "Vought"
date: "November 15, 2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)

```

## R Markdown

## If necessary to install packages
## install.packages("maptools", dependencies = TRUE)
## install.packages("spdep", dependencies = TRUE)
## install.packages("leaflet", dependencies = TRUE)
## install.packages("RColorBrewer", dependencies = TRUE)

```{r}
library(maptools)
library(sf)
```

##using sf instead, so it is easier

Download shapefiles to import into R at the following link: http://www.econ.uiuc.edu/~lab/workshop/foreclosures/.

Download the following:
Main file: foreclosures.shp
Index file: foreclosures.shx
dBASE table: foreclosures.dbf

Move them into a folder within your R project.  Then use setwd to pull from that folder and read in the foreclosures shapefile.

```{r}

setwd("C:/Users/lvoug/Documents/GeoStatsSISS/foreclosures")
chi.poly <- st_read('foreclosures.shp')
```

```{r}
class(chi.poly)

#data frame
```

```{r}
summary(chi.poly$violent)
```

## violent crime in Chicago summary statistics

```{r}
plot(chi.poly, max.plot= 16)

#makes plot images of all variables in chi.poly
```

```{r}
##install.packages('leaflet')

library(leaflet)

leaflet(chi.poly) %>%
  addPolygons(stroke = FALSE, fillOpacity = 0.5, smoothFactor = 0.5) %>%
  addTiles() #adds a map tile, the default is OpenStreetMap

require(RColorBrewer)

pal <- colorQuantile(
  palette  = "OrRd",
  domain = chi.poly$violent)

map <- leaflet(chi.poly)

map %>%
  addPolygons(stroke = FALSE, smoothFactor = 0.2, fillOpacity = 1,
              color = ~pal(violent)) %>% addTiles()
```

We can take the data from our shapefile and do statistical analysis with it too.  


We can start by taking a standard OLS regression by looking at the effect of unemployment and percent of mortgages in the area being  foreclosed.
#OLS


```{r}
chi.ols<-lm(chi.poly$violent~chi.poly$est_fcs_rt+chi.poly$bls_unemp, data=chi.poly$data)

summary(chi.ols)
```

Interpret the coefficients.  Is there a potential issue with using OLS in spatial analysis?

#Identifying Spatial Dependence/Autocorrelation

We can use the spdep package to estimate spatial dependence using the queen criterion of contiguity.  If we use queen=TRUE, then it will use queen criterion.  If we use queen=FALSE, we will have rook criterion.

```{r}
library(magick)
image_url <- "https://i.stack.imgur.com/CWIHi.jpg"
pic <- image_read(image_url)
print(pic)
```


```{r}
library(spdep)
list.queen<-poly2nb(chi.poly, queen=TRUE)
W<-nb2listw(list.queen, style="W", zero.policy=TRUE)
W
```

We can plot our spatial autocorrelation on our polygon.

```{r}
plot(W,chi.poly$geometry)
```

